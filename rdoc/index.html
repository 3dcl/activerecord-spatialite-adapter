<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>SpatiaLite ActiveRecord Adapter 0.4.1 Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body>
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./History_rdoc.html">History</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./ActiveRecord/Base.html">ActiveRecord::Base</a>
  
    <li><a href="./ActiveRecord/ConnectionAdapters/SpatiaLiteAdapter/NativeFormatParser.html">ActiveRecord::ConnectionAdapters::SpatiaLiteAdapter::NativeFormatParser</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation" class="description">
  
<h2 id="label-SpatiaLite+ActiveRecord+Adapter">SpatiaLite ActiveRecord Adapter</h2>

<p>The SpatiaLite ActiveRecord Adapter is an ActiveRecord connection adapter
based on the standard sqlite3 adapter. It extends the standard adapter to
provide support for spatial extensions using SpatiaLite, using the <a
href="http://github.com/dazuma/rgeo">RGeo</a> library to represent spatial
data in Ruby. Like the standard sqlite3 adapter, this adapter requires the
sqlite3-ruby gem.</p>

<h2 id="label-What+This+Adapter+Provides">What This Adapter Provides</h2>

<h3 id="label-Spatial+Migrations">Spatial Migrations</h3>

<p>First, this adapter extends the migration syntax to support creating 
spatial columns and indexes. To create a spatial column, use the
<code>:geometry</code> type, or any of the OGC spatial types such as
<code>:point</code> or <code>:line_string</code>. To create a spatial
index, set the <code>:spatial</code> option to true.</p>

<p>Examples:</p>

<pre class="ruby"><span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">my_spatial_table</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">column</span> :<span class="ruby-identifier">latlon</span>, :<span class="ruby-identifier">point</span>  <span class="ruby-comment"># or t.point :latlon</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">line_string</span> :<span class="ruby-identifier">path</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">geometry</span> :<span class="ruby-identifier">shape</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">change_table</span> :<span class="ruby-identifier">my_spatial_table</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">index</span> :<span class="ruby-identifier">latlon</span>, :<span class="ruby-identifier">spatial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Spatial+Attributes">Spatial Attributes</h3>

<p>When this adapter is in use, spatial attributes in your ActiveRecord
objects will have RGeo geometry values. You can set spatial attributes
either to RGeo geometry objects, or to strings in WKT (well-known text)
format, which the adapter will automatically convert to geometry objects.</p>

<p>Spatial objects in RGeo are tied to a factory that specifies the coordinate
system as well as other behaviors of the object. You must therefore specify
a factory for each spatial column (attribute) in your ActiveRecord class.
You can either set an explicit factory for a specific column, or provide a
factory generator that will yield the appropriate factory for the table’s
spatial columns based on their types. For the former, call the
<code>set_rgeo_factory_for_column</code> class method on your ActiveRecord
class. For the latter, set the rgeo_factory_generator class attribute. This
generator should understand at least the <code>:srid</code> option, which
will be provided based on the column’s specified SRID. Note that the
spatialite adapter does not currently support Z or M coordinates, as it’s
unclear to me whether SpatiaLite itself supports them. The
set_rgeo_factory_for_column and rgeo_factory_generator methods are actually
implemented and documented in the “rgeo-activerecord” gem.</p>

<p>Examples, given the spatial table defined above:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MySpatialTable</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>

  <span class="ruby-comment"># By default, use the GEOS implementation for spatial columns.</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">rgeo_factory_generator</span> = <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">Geos</span>.<span class="ruby-identifier">method</span>(:<span class="ruby-identifier">factory</span>)

  <span class="ruby-comment"># But use a geographic implementation for the :latlon column.</span>
  <span class="ruby-identifier">set_rgeo_factory_for_column</span>(:<span class="ruby-identifier">latlon</span>, <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">Geographic</span>.<span class="ruby-identifier">spherical_factory</span>)

<span class="ruby-keyword">end</span>
</pre>

<p>Now you can interact with the data using the RGeo types:</p>

<pre class="ruby"><span class="ruby-identifier">rec</span> = <span class="ruby-constant">MySpatialTable</span>.<span class="ruby-identifier">new</span>
<span class="ruby-identifier">rec</span>.<span class="ruby-identifier">latlon</span> = <span class="ruby-string">'POINT(-122 47)'</span>   <span class="ruby-comment"># You can set by feature object or WKT.</span>
<span class="ruby-identifier">loc</span> = <span class="ruby-identifier">rec</span>.<span class="ruby-identifier">latlon</span>                <span class="ruby-comment"># Accessing always returns a feature object, in</span>
                                <span class="ruby-comment"># this case, a geographic that understands latitude.</span>
<span class="ruby-identifier">loc</span>.<span class="ruby-identifier">latitude</span>                    <span class="ruby-comment"># =&gt; 47</span>
<span class="ruby-identifier">rec</span>.<span class="ruby-identifier">shape</span> = <span class="ruby-identifier">loc</span>                 <span class="ruby-comment"># the factory for the :shape column is GEOS, so the</span>
                                <span class="ruby-comment"># value will be cast from geographic to GEOS.</span>
<span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">Geos</span>.<span class="ruby-identifier">is_geos?</span>(<span class="ruby-identifier">rec</span>.<span class="ruby-identifier">shape</span>)  <span class="ruby-comment"># =&gt; true</span>
</pre>

<h3 id="label-Spatial+Queries">Spatial Queries</h3>

<p>You can create simple queries based on objective equality in the same way
you would on a scalar column:</p>

<pre class="ruby"><span class="ruby-identifier">rec</span> = <span class="ruby-constant">MySpatialTable</span>.<span class="ruby-identifier">where</span>(:<span class="ruby-identifier">latlon</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">RGeo</span><span class="ruby-operator">::</span><span class="ruby-constant">Geos</span>.<span class="ruby-identifier">factory</span>.<span class="ruby-identifier">point</span>(<span class="ruby-value">-122</span>, <span class="ruby-value">47</span>)).<span class="ruby-identifier">first</span>
</pre>

<p>You can also use WKT:</p>

<pre class="ruby"><span class="ruby-identifier">rec</span> = <span class="ruby-constant">MySpatialTable</span>.<span class="ruby-identifier">where</span>(:<span class="ruby-identifier">latlon</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'POINT(-122 47)'</span>).<span class="ruby-identifier">first</span>
</pre>

<p>The adapter also provides experimental support for more complex queries
such as radius searches. However, these extensions require Arel 2.1 (which
is scheduled for release with Rails 3.1). We do not have these documented
yet, and the syntax is subject to change. For now, you should write more
complex queries in SQL.</p>

<h2 id="label-Installation+And+Configuration">Installation And Configuration</h2>

<h3 id="label-Installing+The+Adapter+Gem">Installing The Adapter Gem</h3>

<p>This adapter has the following requirements:</p>
<ul><li>
<p>Ruby 1.8.7 or later. Ruby 1.9.2 or later preferred.</p>
</li><li>
<p>sqlite 3.7.3 or later.</p>
</li><li>
<p>SpatiaLite 3.0 or later. Version 2.3 may work but is not officially
supported.</p>
</li><li>
<p>sqlite3 gem 1.3.5 or later.</p>
</li><li>
<p>ActiveRecord 3.0.3 or later. Earlier versions will not work. Should be
compatible with Rails versions through 3.2.x.</p>
</li><li>
<p>rgeo gem 0.3.7 or later.</p>
</li><li>
<p>rgeo-activerecord gem 0.4.3 or later.</p>
</li></ul>

<p>Note: if you are running Mac OS X, the OS-provided copy of sqlite3 may not
support extensions. You should install an alternate copy of sqlite3 (for
example, using MacPorts or Homebrew) reinstall the gem using:</p>

<pre>gem install sqlite3 -- --with-sqlite3-dir=/path/to/alternate/sqlite3</pre>

<p>Install this adapter as a gem:</p>

<pre>gem install activerecord-spatialite-adapter</pre>

<p>See the <a href="README_rdoc.html">README</a> for the “rgeo” gem, a
required dependency, for further installation information.</p>

<h3 id="label-Setting+Up+The+Adapter">Setting Up The Adapter</h3>

<p>To use this adapter, add this gem, “activerecord-spatialite-adapter”, to
your Gemfile, and then request the adapter name “spatialite” in your
database connection configuration (which, for a Rails application, is in
the config/database.yml file). The other database connection configuration
parameters are the same as for the stock sqlite3 adapter, with the
exception of one additional parameter, <code>libspatialite</code>, which
should be set to the full path to the libspatialite shared library, if it
is not installed in a standard place (such as /usr/local or /opt/local).</p>

<p>Generally, you can create a new Rails application using:</p>

<pre>rails new my_app --database=sqlite3</pre>

<p>…and then change the adapter names to “<code>spatialite</code>” and add an
appropriate <code>libspatialite</code> setting.</p>

<p>Next, the SpatiaLite adapter includes a special railtie that provides
support for SpatiaLite databases in ActiveRecord’s rake tasks. This railtie
is required in order to run, e.g., rake test. To install this railtie, you
should add this line to your config/application.rb:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">'active_record/connection_adapters/spatialite_adapter/railtie'</span>
</pre>

<p>Note that this railtie must load after the ActiveRecord railtie. That is,
the above require command should appear after <code>require
'rails/all'</code>.</p>

<h3 id="label-Dealing+with+SpatiaLite+Definitions">Dealing with SpatiaLite Definitions</h3>

<p>SpatiaLite adds many objects (meta-information tables, functions, triggers,
etc.) to a Sqlite3 database. These objects are required to maintain the
spatial elements of the database, but they can be a hassle when managing
the database with Rails. Following are some tips and gotchas that you may
encounter.</p>

<p>Make sure you include the correct <code>libspatialite</code> setting in
your database.yml config file, especially for your production environments.</p>

<p>SpatiaLite databases need to be initialized by executing the SpatiaLite
initialization script or by calling the InitSpatialMetaData() function. The
rake db:create task will do this for you when it creates a database. Thus,
when setting up a new application, you should make sure you call rake
db:create or otherwise cause the SpatiaLite initialization to occur, before
you attempt to run your first migration. Failure to do so will result in
errors during the migration.</p>

<p>Dumping a SpatiaLite database as SQL will cause a bunch of internal tables
and triggers to be included in your dump. These are the actual SpatiaLite
implementation objects used to enforce spatial constraints and implement
spatial indexes. Unfortunately, not only is this a bit unsightly, but not
everything is dumped here: for example, for each spatial column, there
should be a row in the geometry_columns table, and those will be missing in
the SQL structure dump. As a result, loading from the SQL structure dump
will not properly reproduce your database schema. Because of this, we
highly recommend that you leave config.active_record.schema_format set to
<code>:ruby</code> for now, so that schema dumps are done in the Ruby
format.</p>

<h2 id="label-Additional+Information">Additional Information</h2>

<h3 id="label-Known+bugs+and+limitations">Known bugs and limitations</h3>

<p>The spatialite adapter works in principle, but there are a few known holes
in the functionality. Notably, things that require the alter_table
mechanism may not function properly, because the current sqlite3
implementation doesn’t properly preserve triggers. This means, among other
things, removing columns in tables with spatial information can cause the
remaining spatial columns to fail. However, most simple things work,
including creating tables with geometric columns, adding geometric columns
to existing tables, and creating and removing spatial R*tree indexes. Note
that this adapter is not yet well tested.</p>

<h3 id="label-Development+and+support">Development and support</h3>

<p>Documentation is available at <a
href="http://dazuma.github.com/activerecord-spatialite-adapter/rdoc">dazuma.github.com/activerecord-spatialite-adapter/rdoc</a></p>

<p>Source code is hosted on Github at <a
href="http://github.com/dazuma/activerecord-spatialite-adapter">github.com/dazuma/activerecord-spatialite-adapter</a></p>

<p>Contributions are welcome. Fork the project on Github.</p>

<p>Report bugs on Github issues at <a
href="http://github.org/dazuma/activerecord-spatialite-adapter/issues">github.org/dazuma/activerecord-spatialite-adapter/issues</a></p>

<p>Support available on the rgeo-users google group at <a
href="http://groups.google.com/group/rgeo-users">groups.google.com/group/rgeo-users</a></p>

<p>Contact the author at dazuma at gmail dot com.</p>

<h3 id="label-Acknowledgments">Acknowledgments</h3>

<p>The SpatiaLite Adapter and its supporting libraries (including RGeo) are
written by Daniel Azuma (<a
href="http://www.daniel-azuma.com">www.daniel-azuma.com</a>).</p>

<p>Development is supported by Pirq. (<a
href="http://www.pirq.com">www.pirq.com</a>).</p>

<h3 id="label-License">License</h3>

<p>Copyright 2010-2012 Daniel Azuma</p>

<p>All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>
<ul><li>
<p>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</p>
</li><li>
<p>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</p>
</li><li>
<p>Neither the name of the copyright holder, nor the names of any other
contributors to this software, may be used to endorse or promote products
derived from this software without specific prior written permission.</p>
</li></ul>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS”
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>

</div>


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

